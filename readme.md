### Процесс получения и обработки данных в 1С:Транспорт (As Is)

Ниже описан текущий процесс (As Is) обмена данными между системами (Продукты, B2B, Биллинг, 1С:Транспорт и 1С:НТТ БУХ), основанный на предоставленном описании схемы, текстовом описании обработки запросов и содержимом PDF-документа. Процесс охватывает этапы от формирования заказа клиентом до создания бухгалтерских документов в 1С:НТТ БУХ. Описание структурировано по ключевым этапам для ясности.

#### 1. Процесс обмена данными между Продуктами, B2B и Биллингом
Обмен данными зависит от типа продукта (HOTEL, BUS, AVIA, TRAIN) и разделяется на два основных сценария:

1.1. Для продуктов HOTEL, BUS и частично AVIA:
   - Клиент оформляет заказ на сайте (бронирование продукта).
   - На этапе оплаты (при выборе "Оплатить") в Биллинг отправляется запрос на списание средств с карты клиента или с депозита (для B2B безнал) в разрезе сумм и позиций.
   - Биллинг списывает средства и направляет данные в "Продукт".
   - Если продажа успешна, "Продукт" подтверждает это Биллингу.
   - Биллинг формирует УПД (универсальный передаточный документ), Транзит и отправляет запрос в 1С:Транспорт.
   - Если продажа не удалась, УПД и Транзит не формируются (даже если средства списаны).

1.2. Для продуктов TRAIN и AVIA:
   - "Продукт" самостоятельно оформляет реализацию, выписывает УПД и формирует Транзит.
   - Данные отправляются в B2B.
   - B2B передает все данные в Биллинг.
   - Биллинг отправляет полученные данные в 1С:Транспорт.

Общий процесс обмена отражен на схеме (Рисунок 1 в документе), где данные проходят через Биллинг как центральный узел.

#### 2. Процесс обмена данными между Биллингом и 1С:Транспортом
- Все операции экспортируются из Биллинга в 1С:Транспорт в формате JSON-запроса.
- Запрос содержит поля, зависящие от типа операции (УПД, УКД, Потеря, Транзит, Холд, УПДТранзит, Штраф). Обязательность полей описана в Таблице 1 документа:
  - Ключевые поля: GUID (уникальный идентификатор операции), Product (тип продукта: AVIA, BUS, TRAIN, HOTELS), ClientType (b2b или b2c), OperationType (тип операции), ContractorKey (ключ покупателя), LegalKey (ключ поставщика для Транзитов), Organization (ИНН организации), DateTime (дата/время в формате "YYYY-MM-DDTHH:MM:SS+TZ"), OrderNumber (номер заказа), UPDNumber (номер УПД), и т.д.
  - Раздел "Услуги" (Services): ServiceName (наименование услуги), ServiceID (ИД услуги), ServiceType (вид услуги, соответствующий номенклатуре в 1С), Quantity (количество), Price (цена без НДС), Amount (сумма без НДС), VAT_Rate (ставка НДС), VAT_Amount (сумма НДС), AmountAll (сумма с НДС).
- Поле IsRefund указывает направление движения средств ("да" для возврата, "нет" для оплаты).
- Если GUID не указан, создается новая операция; если указан — обновляется существующая.

#### 3. Процесс обработки запроса в базе 1С:Транспорт (формирование документа "Операция Б2Б")
- Поступление и проверка запроса:
  - Запрос приходит в формате JSON в транспортную базу.
  - Происходит проверка запроса.
  - Если проверка пройдена:
    - Запрос записывается в регистр сведений (РС) "Входящие операции Б2Б" (раздел "Шина интеграции").
    - Регистр в запросе получает значение.
    - Запись в РС "Протокол" с типом "Информация".
  - Если проверка не пройдена:
    - Запись в РС "Протокол" с типом "Ошибка".
    - Возврат ошибки в ответ на запрос.

- Формирование документа "Операция Б2Б":
  - Формирование стартует фоновым заданием сразу после записи в РС, не задерживая обработку запроса.
  - Документ находится в разделе "Основные объекты интеграции" > "Операции Б2Б".
  - Документ универсальный и содержит все реквизиты для любых типов операций.
  - Процесс:
    - Запрос копируется в документ, разбивается на реквизиты.
    - Заполняются ссылки на элементы справочников транспортной базы.
    - Если контрагент не найден по ContractorKey: фоновый запрос в сервис B2B, создание нового элемента в справочнике "Контрагенты".
    - Поиск договора поставщика: по РС "Договоры поставщиков Б2Б" (измерения: Организация, Продукт, Поставщик услуг; ресурс: Договор поставщика).
      - Если не найден: запрос в 1С:НТТ БУХ для поиска крайнего договора с видом "С комитентом (принципалом) на продажу".
      - Если найден: перенос в 1С:Транспорт и подстановка в документ.
      - Если не найден: создание в 1С:НТТ БУХ с наименованием "#API B2B", перенос в 1С:Транспорт (бухгалтер корректирует наименование позже для агенсткого вознаграждения).
    - Проверка вида оплаты: по РС "Настройки обмена Б2Б" (вид оплаты, эквайринг).
    - Проверка номенклатуры: по РС "Настройки номенклатуры БП" (измерения: Продукт, Тип операции, Номенклатура (соответствует ServiceType), Способ оплаты (нал/безнал), Вид клиента (b2b/b2c); ресурс: Номенклатура ссылка).
      - Вид услуги (ServiceType) определяется по таблице "Виды услуг" (ссылка в документе: https://miro.com/app/board/o9J_ljowKRY=/?moveToWidget=3458764529377264338&cot=14).
  - Если настройки в РС отсутствуют, запрос не обработается корректно.

#### 4. Передача данных из 1С:Транспорт в 1С:НТТ БУХ
- Условия и частота передачи:
  - Передача осуществляется регламентным заданием 1 раз в час.
  - Определяется по РС "Настройка трансляции бух Б2Б" в 1С:Транспорт: если галочка "Передать" — данные передаются; если нет — не передаются.
- Сопоставление объектов:
  - По GUID (в 1С:НТТ БУХ — дополнительное сведение "ГУИД_B2B").
  - Заполняется РС "Соответствие объектов информационных баз" в 1С:Транспорт (не в НТТ).
- Алгоритм выгрузки:
  - Перед выгрузкой: если есть соответствие в РС — выгружается только GUID; если нет — все поля (увеличивает размер пакета).
  - При выгрузке: документ ищется по GUID; справочники — по GUID, если не найдено — по полю поиска (LegalKey, номер договора); номенклатура — только по GUID.
  - На текущий момент один пакет содержит одну операцию.
  - За правила проведения документов отвечает HTTP-сервис "Загрузка_ИзТранспорта".
  - Контроль отправки: через План обмена, с регистрацией изменений для обмена данными.

#### 5. Формирование документов в 1С:НТТ БУХ в зависимости от типа операции
- На основе данных из 1С:Транспорт формируются документы в 1С:НТТ БУХ.
- Примеры (зависит от продукта, вида клиента и типа оплаты):
  - Для AVIA, b2b, безнал: "Реализация (акт, накладная, УПД)" (сумма СС), "Счет-фактура выданный" (сумма НДС), "Операция" (сумма транзита).
  - Для AVIA, b2b, нал: "Реализация (акт, накладная, УПД)" (сумма СС), "Счет-фактура выданный" (сумма НДС), "Операция по платежной карте" (факт оплаты СС).
- В каждом документе есть реквизит "Дополнительные сведения" (кнопка в журнале или документе), отображающий детали (Рисунок 10).
- Детали проводок по продуктам — в таблице "Проводки" (ссылка: https://miro.com/app/board/o9J_ljowKRY=/?moveToWidget=3458764528170449649&cot=14).
- Ссылка на задачу в Jira: CONTOUR-182.

Этот процесс As Is обеспечивает интеграцию данных от заказа до бухгалтерского учета, но зависит от корректных настроек регистров и может требовать ручных корректировок (например, договоров "#API B2B").
